<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý sản phẩm</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/reset.css}" />
    <link rel="stylesheet" th:href="@{/css/admin.css}" />
    <link rel="stylesheet" th:href="@{/css/manageProduct.css}" />
    
    <style>
        /* CSS CHỮA CHÁY: Đảm bảo bảng hiển thị đẹp ngay cả khi file css ngoài bị lỗi */
        .sku-row { display: none; }
        .sku-row.show { display: table-row; }
        .sku-box { padding: 15px; background: #f8f9fa; border: 1px solid #eee; margin: 10px; }
        .sku-table { width: 100%; border-collapse: collapse; background: #fff; }
        .sku-table th, .sku-table td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        
        /* QUAN TRỌNG: Giúp ô nhập liệu hiện rõ số ngay cả khi bị khóa */
        .stock-input:disabled {
            background: transparent;
            border: 1px solid transparent;
            color: #333 !important;
            opacity: 1; /* Fix lỗi mờ trên một số trình duyệt */
            -webkit-text-fill-color: #333;
            font-weight: bold;
            text-align: center;
        }
        .stock-input:not(:disabled) {
            background: #fff;
            border: 1px solid #007bff;
        }
    </style>
</head>

<body>
<div class="content">
    <div class="left-content">
        <h1>ADMIN CONTROL</h1>
        <div class="divider"></div>

        <nav class="side-bar">
          <ul>
            <li data-page="dashboard">
              <a th:href="@{/admin/dashboard}">
                <img th:src="@{/img/Subtract.svg}" /> Tổng quan
              </a>
            </li>

            <li data-page="addProduct">
              <a th:href="@{/admin/addProduct}">
                <img th:src="@{/img/add-icon.svg}" /> Thêm sản phẩm
              </a>
            </li>

            <li data-page="manageProduct">
              <a th:href="@{/admin/manageProduct}">
                <img th:src="@{/img/manage-product.svg}" /> Quản lý sản phẩm
              </a>
            </li>

            <li data-page="manageOrder">
              <a th:href="@{/admin/manageOrder}">
                <img th:src="@{/img/manage-order.svg}" /> Quản lý đơn hàng
              </a>
            </li>

            <li data-page="manageCustomer">
              <a th:href="@{/admin/manageCustomer}">
                <img th:src="@{/img/customer.svg}" /> Khách hàng
              </a>
            </li>
          </ul>
        </nav>
      </div>

    <div class="right-content">
        <h1>Danh sách sản phẩm</h1>

        <div class="container">
          <!-- FILTER -->
          <form th:action="@{/admin/manageProduct}" method="get" class="filter-bar">
            <div class="search-box">
              <input type="text"
               placeholder="Tìm Kiếm Sản Phẩm"
               name="keyword"
              />
              <img th:src="@{/img/Search_light.svg}" class="icon" />
            </div>

            <select name="categoryName">
              <option value=""> Tất cả loại </option>
              <option value="Áo" th:selected="${param.categoryName == 'Áo'}">Áo</option>
              <option value="Quần" th:selected="${param.categoryName == 'Quần'}">Quần</option>
              <option value="Đầm" th:selected="${param.categoryName == 'Đầm'}">Đầm</option>
              <option value="Chân Váy" th:selected="${param.categoryName == 'Chân Váy'}">Chân Váy</option>
              <option value="Phụ Kiện" th:selected="${param.categoryName == 'Phụ Kiện'}">Phụ Kiện</option>
            </select>

            <select name="status">
              <option value="">-- Tất cả trạng thái --</option>
              <option value="true" th:selected="${param.status == 'true'}">Đang Bán</option>
              <option value="false" th:selected="${param.status == 'false'}">Ngừng Bán</option>
            </select>

            <button type="submit" class="btn-search">Tìm Kiếm</button>
            <a th:href="@{/admin/manageProduct}" 
              th:if="${!#strings.isEmpty(param.keyword) or !#strings.isEmpty(param.categoryName) or !#strings.isEmpty(param.status)}"
              style="margin-left: 10px; color: #dc3545; text-decoration: none; font-size: 0.9em; display: flex; align-items: center; cursor: pointer; font-weight: bold;">
              <span style="font-size: 20px;">
                <i class="fa-solid fa-xmark" style="font-size: 30px;"></i>
              </span>
               Xóa lọc
            </a>
          </form>

            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                <tr style="background: #eee;">
                    <th style="padding:10px;">ID</th>
                    <th>Sản Phẩm</th>
                    <th>Giá</th>
                    <th>Số lượng</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
                </thead>

                <tbody>
                <th:block th:each="p : ${products}">

                    <tr class="product-row" th:id="'product-row-' + ${p.id}" th:data-id="${p.id}" style="border-bottom: 1px solid #ddd;">
    
                      <td th:text="${p.id}" style="padding: 10px; font-size: 20px;"></td>

                      <td>
                          <div class="display-mode" style="display: flex; align-items: center; gap: 10px;">
                              <img th:src="${p.mainImage}" 
                                  class="p-img" 
                                  style="width: 150px; height: 180px; object-fit: cover; border-radius: 4px; border: 1px solid #eee;" 
                                  onerror="this.src='/img/no-image.png'" /> 
                              
                              <div>
                                  <div th:text="${p.name}" class="p-name" style="font-weight: bold;font-size: 20px;"></div>
                                  <div style="font-size: 0.9em; color: #666;font-size: 20px;">
                                      <span th:each="v, iter : ${p.variants}" th:text="${v.size} + ${!iter.last ? ', ' : ''}" style="font-size: 20px;"></span>
                                  </div>
                              </div>
                          </div>

                          <div class="edit-mode" style="display: none; flex-direction: column; gap: 5px;">
                              
                              <input type="text" class="edit-name" th:value="${p.name}" placeholder="Tên sản phẩm" 
                                    style="width: 100%; padding: 5px; border: 1px solid #007bff; border-radius: 3px;">
                              
                              <input type="file" 
                                  class="edit-img-file" 
                                  multiple 
                                  accept="image/*"
                                  style="width: 100%; padding: 5px; border: 1px solid #ddd; font-size: 0.8em; border-radius: 3px;">
                            <small style="color: #666; font-size: 0.7em;">*Chọn ảnh mới để thay thế (Giữ Ctrl để chọn nhiều ảnh)</small>
                          </div>
                      </td>

                      <td>
                          <span class="display-mode" th:text="${#numbers.formatDecimal(p.price, 0, 'POINT', 0, 'POINT')}"></span>
                          <input type="number" class="edit-mode edit-price" th:value="${p.price}" min="0" 
                                style="display: none; width: 100px; padding: 5px; border: 1px solid #007bff;">
                      </td>

                      <td class="qty" th:id="'total-stock-' + ${p.id}" th:text="${p.totalStock}" style="font-weight: bold; font-size: 25px;"></td>

                      <td>
                          <span class="display-mode" 
                                style="font-size: 25px;"
                                th:text="${p.status} ? 'Đang Bán' : 'Ngừng Bán'"
                                th:style="${p.status} ? 'color: green;' : 'color: red;'">
                          </span>
                          
                          <select class="edit-mode edit-status" style="display: none; padding: 5px; border: 1px solid #007bff;">
                              <option value="true" th:selected="${p.status == true}">Đang Bán</option>
                              <option value="false" th:selected="${p.status == false}">Ngừng Bán</option>
                          </select>
                      </td>

                      <td>
                          <div class="action-group-view">
                              <button class="btn-detail" style="cursor: pointer; padding: 5px 10px; border: 1px solid #ddd; font-size: 20px;"><i class="fa-solid fa-chevron-down"></i> Chi tiết</button>
                              <button class="btn-edit-product" title="Sửa SP" style="cursor: pointer; border: none; background: none; color: blue; font-size: 1.2em; margin-left: 5px;"><i class="fa-solid fa-pen" style="font-size: 18px;"></i></button>
                              <button class="btn-delete-product" title="Xóa SP" style="cursor: pointer; border: none; background: none; color: red; font-size: 1.2em;"><i class="fa-solid fa-trash" style="font-size: 18px;"></i></button>
                          </div>

                          <div class="action-group-edit" style="display: none;">
                              <button class="btn-save-product" style="cursor: pointer; border: none; background: none; color: green; font-size: 1.4em;"><i class="fa-solid fa-check"></i></button>
                              <button class="btn-cancel-product" style="cursor: pointer; border: none; background: none; color: red; font-size: 1.4em;"><i class="fa-solid fa-xmark"></i></button>
                          </div>
                      </td>
                    </tr>
                    <tr class="sku-row" th:data-parent-id="${p.id}">
                        <td colspan="6" style="padding: 0;">
                            <div class="sku-box">
                                <div style="margin-bottom: 10px; font-weight: bold;">Danh sách SKU</div>

                                <table class="sku-table">
                                    <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Tồn kho</th>
                                        
                                        <th>Hành động</th>
                                    </tr>
                                    </thead>

                                    <tbody>
                                          <tr th:each="v : ${p.variants}" th:data-id="${v.id}">
                                              <td style="vertical-align: middle;">
                                                  <span th:text="${v.size}" style="font-weight: bold;"></span>
                                              </td>

                                              

                                              <td style="vertical-align: middle;">
                                                    <span class="stock-display" 
                                                          th:text="${v.stock}" 
                                                          style="font-weight: bold; font-size: 1.1em; color: #333;">
                                                    </span>

                                                    <input type="number" 
                                                          class="stock-input" 
                                                          th:value="${v.stock}" 
                                                          min="0"
                                                          style="display: none; width: 80px; text-align: center; border: 1px solid #007bff;">
                                                </td>

                                              <td style="vertical-align: middle;">
                                                  <button class="btn-edit" title="Sửa" style="cursor: pointer; border: none; background: none; font-size: 1.2em;"><i class="fa-solid fa-pen"></i></button>
                                                  <button class="btn-save" title="Lưu" style="display: none; cursor: pointer; border: none; background: none; color: green; font-size: 1.2em;"><i class="fa-solid fa-check"></i></button>
                                                  <button class="btn-cancel" title="Hủy" style="display: none; cursor: pointer; border: none; background: none; color: red; font-size: 1.2em;"><i class="fa-solid fa-xmark"></i></button>
                                                  <button class="btn-delete" title="Xóa" style="cursor: pointer; border: none; background: none; color: red; font-size: 1.2em; margin-left: 10px;"><i class="fa-solid fa-trash"></i></button>
                                              </td>
                                          </tr>
                                      </tbody>
                                </table>
                                <div class="add-form" style="margin-top: 15px; padding: 15px; background: #f1f8ff; border: 1px dashed #007bff; border-radius: 5px; display: flex; align-items: center; gap: 10px;">
                                    <strong style="white-space: nowrap;">+ Thêm SKU mới:</strong>
                                    
                                    <input type="text" class="new-size" placeholder="Nhập Size (VD: XXL)" 
                                          style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">
                                    
                                    <input type="number" class="new-stock" placeholder="Số lượng" min="0"
                                          style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px;">
                                    
                                    <button class="btn-add-confirm" 
                                            style="background: #28a745; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                        Lưu
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
<script th:src="@{/js/manageProduct.js}"></script>
</html>