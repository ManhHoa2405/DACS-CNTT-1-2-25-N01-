<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết sản phẩm</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Abel&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />

    <link rel="stylesheet" th:href="@{/css/reset.css}" />
    <link rel="stylesheet" th:href="@{/css/user.css}" />
    <link rel="stylesheet" th:href="@{/css/detailProduct.css}" />

    <style>
      #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 16px;
        position: fixed;
        z-index: 1000;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 16px;
        font-family: 'Montserrat', sans-serif;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.5s, bottom 0.5s;
      }

      #toast.show {
        visibility: visible;
        opacity: 1;
        bottom: 50px;
      }
      
      /* Thêm hiệu ứng loading cho nút */
      .add-cart:disabled {
          background-color: #999;
          cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <header class="header">
        <div class="banner"><p>Miễn phí vận chuyển cho mọi đơn hàng</p></div>
        <nav class="navbar">
             <a th:href="@{/user/homePage}"><img th:src="@{/img/Logo.svg}" alt="Modimal" /></a>
             <div class="actions">
                 <div class="cart">
                    <a th:href="@{/user/cart}"><img th:src="@{/img/Header bag icon.svg}" alt="Cart" /></a>
                 </div>
             </div>
        </nav>
    </header>

    <main class="product-detail">
      <div class="breadcrumb">
        <a th:href="@{/user/homePage}">Trang Chủ</a>
        <span>/</span>
        <th:block th:if="${p.category != null}">
          <a th:href="@{/user/showProduct(categoryName=${p.category.name})}" th:text="${p.category.name}"></a>
        </th:block>
        <span>/</span>
        <strong class="active" th:text="${p.name}"></strong>
      </div>

      <div class="product-wrapper">
        <div class="product-gallery">
          <div class="thumbs">
              <th:block th:if="${not #lists.isEmpty(p.images)}">
                  <img th:each="img, iter : ${p.images}" 
                       th:src="${img.imageUrl}" 
                       class="thumb" 
                       th:classappend="${iter.index == 0 ? 'active' : ''}"
                       onclick="changeImage(this)"
                       style="cursor: pointer; object-fit: cover;">
              </th:block>
              <img th:if="${#lists.isEmpty(p.images)}" src="/img/no-image.png" class="thumb active">
          </div>
          <div class="main-image">
              <img id="mainProductImage"
                   th:src="${not #lists.isEmpty(p.images) ? p.images[0].imageUrl : '/img/no-image.png'}" 
                   style="width: 100%; height: auto; object-fit: contain;" />
          </div>
        </div>

        <div class="product-info">
            <form id="addCartForm" th:action="@{/user/cart/add}" method="POST">
              <h1 th:text="${p.name}"></h1>
    
              <div class="price">Giá:<p class="price" th:text="${#numbers.formatDecimal(p.price, 0, 'POINT',0 , 'POINT')} + ' VNĐ'"></p></div>
    
              <div class="quantity">
                <button type="button" class="qty-btn minus">-</button>
                <input type="number" class="qty-input" name="quantity" value="1" min="1" readonly />
                <button type="button" class="qty-btn plus" >+</button>
              </div>
    
              <div class="status">Trạng Thái:<p th:text="${(p.status == true) ? 'Còn Hàng' : 'Hết Hàng'}"> </p></div>          

              <select class="size-select" name="variantId" required>
                <option value="" disabled selected>Kích Thước</option>
                <th:block th:each="v :${p.variants}">
                  <option th:value="${v.id}" th:text="${v.size}" th:if="${v.stock > 0}"></option>
                </th:block>
              </select>
    
              <button class="add-cart" type="submit">Thêm Vào Giỏ Hàng</button>
    
              <div class="policy">
                <img th:src="@{/img/local_shipping.svg}" />
                <span>Dễ Dàng Hoàn Trả</span>
              </div>
            </form>
        </div>
      </div>
    </main>

    <footer class="footer">
        </footer>

    <div id="toast">Đã thêm vào giỏ hàng thành công!</div>

    <script>
      // 1. Logic đổi ảnh Gallery
      const thumbs = document.querySelectorAll(".thumb");
      const mainImage = document.getElementById("mainProductImage");
      
      function changeImage(element) {
          mainImage.src = element.src;
          thumbs.forEach((t) => t.classList.remove("active"));
          element.classList.add("active");
      }

      // 2. Logic Toast Thông Báo
      function showToast(message, isError = false) {
          const toast = document.getElementById("toast");
          toast.innerText = message;
          toast.style.backgroundColor = isError ? "#d9534f" : "#333"; // Đỏ nếu lỗi, đen nếu thành công
          
          toast.className = "show";
          setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
      }

      // 3. XỬ LÝ AJAX THÊM VÀO GIỎ (QUAN TRỌNG)
      document.getElementById("addCartForm").onsubmit = function(event) {
          event.preventDefault(); // Chặn chuyển trang

          const form = event.target;
          const formData = new FormData(form);
          const btn = form.querySelector(".add-cart");
          
          // Validate cơ bản: Kiểm tra đã chọn size chưa
          if(!formData.get("variantId")) {
              showToast("Vui lòng chọn kích thước!", true);
              return;
          }

          // Disable nút để tránh click nhiều lần
          btn.disabled = true;
          btn.innerText = "Đang thêm...";

          fetch(form.action, {
              method: 'POST',
              body: formData
          })
          .then(response => {
              if (response.status === 401) {
                  // Nếu chưa đăng nhập (Backend trả 401)
                  window.location.href = "/account/login";
                  throw new Error("Redirecting to login");
              }
              return response.json();
          })
          .then(data => {
              if (data.status === 'success') {
                  showToast("✅ " + data.message);
                  // Reset form nếu muốn (tuỳ chọn)
                  // form.reset(); 
              } else {
                  showToast("❌ " + (data.message || "Lỗi không xác định"), true);
              }
          })
          .catch(error => {
              if (error.message !== "Redirecting to login") {
                  console.error('Error:', error);
                  showToast("❌ Lỗi kết nối server!", true);
              }
          })
          .finally(() => {
              // Mở lại nút sau khi xong
              btn.disabled = false;
              btn.innerText = "Thêm Vào Giỏ Hàng";
          });
      };
    </script>

    <script th:src="@{/js/quantity.js}"></script>
  </body>
</html>