<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ hàng Modimal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/reset.css}" />
    <link rel="stylesheet" th:href="@{/css/cart.css}" />

    <style>
      .checkout-btn.disabled {
        background-color: #ccc !important;
        cursor: not-allowed;
        pointer-events: none; /* Chặn click bằng CSS */
      }
    </style>
  </head>
  <body>
    <header class="header">
      <nav class="navbar">
        <a th:href="@{/user/homePage}">
          <img th:src="@{/img/Logo.svg}" alt="Modimal" width="150" />
        </a>
      </nav>
    </header>

    <main class="cart-page">
      <div id="toast"></div>
      <div class="cart-nav">
        <div class="left-nav">
          <a th:href="${backLink}" class="back-link">Trở Lại</a>
          <h1 class="cart-title">Giỏ Hàng Của Bạn</h1>
        </div>
        <a th:href="@{/user/homePage}" class="continue-link"
          >Tiếp Tục Mua Sắm</a
        >
      </div>

      <div class="cart-layout">
        <div class="cart-left-section">
          <div class="section-head">
            <span>Chọn Sản Phẩm</span>
          </div>

          <div
            th:each="item : ${items}"
            class="item-row-left"
            th:id="'left-row-' + ${item.id}"
          >
            <form th:action="@{/user/cart/select}" method="post">
              <input type="hidden" th:value="${item.id}" name="cartItemId" />
              <div class="checkbox-wrapper">
                <input
                  type="checkbox"
                  class="product-checkbox"
                  name="selected"
                  th:checked="${item.isSelected}"
                  th:data-id="${item.id}"
                  onchange="handleSelect(this)"
                />
              </div>
            </form>

            <div class="cart-product">
              <img
                th:src="@{${item.productVariant.product.images[0].imageUrl}}"
              />
              <div class="product-info">
                <h4 th:text="${item.productVariant.product.name}"></h4>
                <p>Size: <span th:text="${item.productVariant.size}"></span></p>
                <p>
                  Giá:
                  <span
                    th:text="${#numbers.formatDecimal(item.productVariant.product.price,0,'COMMA',0,'POINT')}"
                  ></span>
                  VND
                </p>
              </div>
            </div>

            <form
              th:action="@{/user/cart/update}"
              method="post"
              class="delete-form"
              th:data-id="${item.id}"
              onsubmit="handleDelete(event, this)"
              style="display: contents"
            >
              <input type="hidden" name="cartItemId" th:value="${item.id}" />
              <input type="hidden" name="quantity" value="0" />
              <button type="submit" class="remove-item">✕</button>
            </form>
          </div>
        </div>

        <div class="cart-right-section">
          <div class="section-head right-head">
            <span>Sản phẩm chọn</span> <span>Giá</span>
            <span>SL</span>
            <span>Tổng</span>
          </div>

          <div
            th:each="item : ${items}"
            class="item-row-right"
            th:id="'right-row-' + ${item.id}"
            th:data-price="${item.productVariant.product.price}"
            th:style="${item.isSelected} ? 'display: grid' : 'display: none'"
          >
            <div
              class="cart-name"
              th:text="${item.productVariant.product.name}"
            ></div>
            <div
              class="cart-price"
              th:text="${#numbers.formatDecimal(item.productVariant.product.price,0,'COMMA',0,'POINT')}"
            ></div>

            <form
              th:action="@{/user/cart/update}"
              method="post"
              class="cart-qty"
            >
              <input type="hidden" name="cartItemId" th:value="${item.id}" />
              <button
                type="submit"
                name="quantity"
                th:value="${item.quantity - 1}"
                class="minus"
              >
                -
              </button>
              <span class="qty-val" th:text="${item.quantity}"></span>
              <button
                type="submit"
                name="quantity"
                th:value="${item.quantity + 1}"
                class="plus"
              >
                +
              </button>
            </form>

            <div
              class="cart-total"
              th:text="${#numbers.formatDecimal(item.productVariant.product.price * item.quantity,0,'COMMA',0,'POINT')}"
            ></div>
          </div>

          <div class="summary-box">
            <div class="summary-divider"></div>
            <div class="summary-row">
              <span>Tổng tiền hàng</span>
              <span id="subtotal">0 VND</span>
            </div>
            <div class="summary-row">
              <span>Phí Vận Chuyển</span>
              <span>Miễn Phí</span>
            </div>
            <div class="summary-row total">
              <span>Tổng Thanh Toán</span>
              <span
                id="final-total"
                th:text="${#numbers.formatDecimal(total,0,'COMMA',0,'POINT')} + ' VND'"
              ></span>
            </div>

            <div class="tax-note">
              Vui lòng chọn sản phẩm bên trái để xem chi tiết hóa đơn.
            </div>

            <a th:href="@{/user/payment}" class="checkout-btn"> Thanh Toán </a>
          </div>
        </div>
      </div>
    </main>

    <script>
      // =================================================
      // 1. XỬ LÝ XÓA SẢN PHẨM (OPTIMISTIC UI)
      // =================================================
      function handleDelete(event, form) {
        event.preventDefault();
        const itemId = form.getAttribute("data-id");
        const formData = new FormData(form);

        // Ẩn ngay
        const leftRow = document.getElementById("left-row-" + itemId);
        const rightRow = document.getElementById("right-row-" + itemId);
        if (leftRow) leftRow.style.display = "none";
        if (rightRow) rightRow.style.display = "none"; // Ẩn dòng bên phải để tính tổng tiền đúng

        updateSummaryDynamic(); // Tính lại tiền

        fetch(form.action, { method: "POST", body: formData })
          .then((response) => {
            if (response.ok) {
              if (leftRow) leftRow.remove();
              if (rightRow) rightRow.remove();
            } else {
              alert("Lỗi kết nối! Không thể xóa sản phẩm.");
              window.location.reload();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            window.location.reload();
          });
      }

      // =================================================
      // 2. XỬ LÝ CHECKBOX
      // =================================================
      function handleSelect(checkbox) {
        const itemId = checkbox.getAttribute("data-id");
        const isChecked = checkbox.checked;

        toggleRightRow(itemId, isChecked);
        updateSummaryDynamic();

        const formData = new FormData();
        formData.append("cartItemId", itemId);
        formData.append("selected", isChecked);

        fetch("/user/cart/select", { method: "POST", body: formData })
          .then((response) => {
            if (!response.ok) throw new Error("Server update failed");
          })
          .catch((error) => {
            console.error("Lỗi đồng bộ:", error);
            checkbox.checked = !isChecked;
            toggleRightRow(itemId, !isChecked);
            updateSummaryDynamic();
            alert("Có lỗi xảy ra, vui lòng thử lại!");
          });
      }

      // =================================================
      // 3. HỖ TRỢ
      // =================================================
      function toggleRightRow(itemId, isChecked) {
        const rightRow = document.getElementById("right-row-" + itemId);
        if (rightRow) {
          // Khi checkbox thay đổi, ta gán style trực tiếp
          rightRow.style.display = isChecked ? "grid" : "none";
        }
      }

      function updateSummaryDynamic() {
        const rightRowsNow = document.querySelectorAll(".item-row-right");
        const subtotalEl = document.getElementById("subtotal");
        const finalTotalEl = document.getElementById("final-total");
        const checkoutBtn = document.querySelector(".checkout-btn");

        let totalBill = 0;

        rightRowsNow.forEach((row) => {
          // Chỉ cộng tiền nếu dòng đó đang hiển thị
          // window.getComputedStyle giúp lấy chính xác trạng thái hiển thị
          if (window.getComputedStyle(row).display !== "none") {
            let rawPrice = row.getAttribute("data-price");
            // Parse giá tiền (chỉ lấy số)
            let price =
              parseFloat(String(rawPrice).replace(/[^0-9.]/g, "")) || 0;
            const qtyVal = row.querySelector(".qty-val");
            const qty = qtyVal ? parseInt(qtyVal.innerText) : 0;
            totalBill += price * qty;
          }
        });

        const formattedMoney = totalBill.toLocaleString("vi-VN") + " VND";
        if (subtotalEl) subtotalEl.innerText = formattedMoney;
        if (finalTotalEl) finalTotalEl.innerText = formattedMoney;

        // Cập nhật trạng thái nút Thanh Toán
        if (checkoutBtn) {
          if (totalBill === 0) {
            checkoutBtn.classList.add("disabled"); // Thêm class disabled (CSS sẽ chặn click)
            checkoutBtn.setAttribute("href", "javascript:void(0)"); // Xóa link
          } else {
            checkoutBtn.classList.remove("disabled");
            checkoutBtn.setAttribute("href", "/user/payment"); // Khôi phục link
          }
        }
      }

      // QUAN TRỌNG: Gọi hàm này ngay khi trang tải xong để đồng bộ trạng thái nút
      document.addEventListener("DOMContentLoaded", function () {
        updateSummaryDynamic();
      });
    </script>
  </body>
</html>
